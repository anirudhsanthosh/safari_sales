<ons-page id="attendance">
  <ons-toolbar>
    <div class="center">Attendance</div>
    <div class="left">
      <ons-back-button modifier="material"></ons-back-button>
    </div>
  </ons-toolbar>
  <div
    class="d-flex w-100 h-100 align-items-center justify-content-center p-4 text-center flex-column"
    id="punch-button-container"
  ></div>
  <script>
    ons.getScriptPage().onInit = function () {
      function getattendanceStatusFromServer() {
        ons.notification.toast("Getting punching status from server", {
          timeout: 1000,
        });
        showModal();

        safari.getAttendanceStatus(user.get("key"), (e) => {
          showModal();
          if (typeof e != "object") {
            toast("Service unavailable please try again later !");
            localStorage.removeItem("punchedIn");
            checkLocationAccess();
            return;
          }

          if (e.status != "success") {
            localStorage.removeItem("punchedIn");
            checkLocationAccess();
            if (typeof e.message == "object") {
              e.message.map((message) => {
                ons.notification.toast(message, { timeout: 5000 });
              });
              return;
            }
            ons.notification.toast(e.message, { timeout: 5000 });
            return;
          }

          switch (e.data.status) {
            case "in":
              localStorage.removeItem("punchedIn");
              break;
            case "out":
              localStorage.punchedIn = "true";
              break;
          }
          checkLocationAccess();
        });
      }

      // calling getattendanceStatusFromServer() to get attendance status
      getattendanceStatusFromServer();

      function punchContainerInner(html) {
        const punchContainer = document.querySelector(
          "#punch-button-container"
        );
        punchContainer.innerHTML = html;
      }

      function punchingContainerContent() {
        if (localStorage.punchedIn) {
          return `<div class="p-2 w-100"><ons-button modifier="large" data-type="out" id="punchingButton">Punch Out</ons-button></div>
                  <div class="p-2 w-100"><ons-button modifier="large" data-type="out" id="weekOffButton">Week Off</ons-button></div>
                  `;
        }
        return `<div class="p-2 w-100"><ons-button modifier="large" data-type="in" id="punchingButton">Punch In</ons-button></div>
                <div class="p-2 w-100"><ons-button modifier="large" data-type="out" id="weekOffButton">Week Off</ons-button></div>`;
      }

      function getPunchingStatus() {
        return document
          .getElementById("punchingButton")
          .getAttribute("data-type");
      }

      async function geolocationSuccess(location) {
        console.log("success", location);
        const mock = await mocklocation();

        console.log(
          user.get("key"),
          location.coords.latitude,
          location.coords.longitude,
          location.coords.accuracy,
          mock,
          getPunchingStatus(),
          console.log
        );

        safari.punchAttendance(
          user.get("key"),
          location.coords.latitude,
          location.coords.longitude,
          location.coords.accuracy,
          mock,
          getPunchingStatus(),
          serverResoponse
        );
      }

      function geolocationError(error) {
        showModal();
        console.log("error", error);
        toast(`Unable to get location, ${error.message}`);
      }
      const geolocationOptions = {
        maximumAge: 3000,
        timeout: 50000,
        enableHighAccuracy: true,
      };

      function punchButtonOnClick() {
        showModal();
        console.log("punch");
        navigator.geolocation.getCurrentPosition(
          geolocationSuccess,
          geolocationError,
          geolocationOptions
        );
      }

      function serverResoponse(e) {
        showModal();
        console.log(e);
        if (typeof e != "object") {
          toast("Service unavailable please try again later !");
          return;
        }

        if (e.status != "success") {
          if (typeof e.message == "object") {
            e.message.map((message) => {
              ons.notification.toast(message, { timeout: 5000 });
            });
            return;
          }
          ons.notification.toast(e.message, { timeout: 5000 });
          return;
        }
        ons.notification.toast("Punching Success", { timeout: 5000 });
        if (!e.buttonStatus) return;
        switch (e.buttonStatus) {
          case "out":
            localStorage.punchedIn = "true";
            break;
          default:
            localStorage.removeItem("punchedIn");
            break;
        }
        checkLocationAccess();
      }

      function weekOffButtonOnClick() {
        showModal();
        safari.punchAttendance(
          user.get("key"),
          "null",
          "null",
          "null",
          false,
          "weekoff",
          serverResoponse
        );
      }

      function gpsEnabled() {
        console.log("enb");
        punchContainerInner(punchingContainerContent());
        document.getElementById("punchingButton").onclick = punchButtonOnClick;
        document.getElementById("weekOffButton").onclick = weekOffButtonOnClick;
      }

      function gpsDisabled() {
        punchContainerInner(
          `<p>Location Access needed in order to perform this Action. Please turn on location service</p>`
        );
      }

      // check location is enabled or not
      function checkLocationStatus() {
        cordova.plugins.diagnostic.isGpsLocationEnabled(
          function (enabled) {
            console.log(
              "GPS location is " + (enabled ? "enabled" : "disabled")
            );
            if (enabled) return gpsEnabled();
            gpsDisabled();
          },
          function (error) {
            console.error("The following error occurred: " + error);
            punchContainerInner(
              `<p>Location Access needed in order to perform this Action.</p>`
            );
          }
        );
      }
      // Location status change event
      if (cordova.platformId === "browser") return;
      cordova.plugins.diagnostic.registerLocationStateChangeHandler(
        (status) => {
          console.log(status);
          checkLocationAccess();
        }
      );

      // request permission to get access to location
      function requestLocationPermission() {
        cordova.plugins.diagnostic.requestLocationAuthorization(
          function (status) {
            switch (status) {
              case cordova.plugins.diagnostic.permissionStatus.NOT_REQUESTED:
                console.log("Permission not requested");
                punchContainerInner(
                  `<p>Location Access needed in order to perform this Action.</p>`
                );
                break;
              case cordova.plugins.diagnostic.permissionStatus.DENIED_ALWAYS:
                console.log("Permission denied");
                punchContainerInner(
                  `<p>Location Access needed in order to perform this Action.</p>`
                );
                break;
              case cordova.plugins.diagnostic.permissionStatus.GRANTED:
                console.log("Permission granted always");
                checkLocationStatus();
                break;
              case cordova.plugins.diagnostic.permissionStatus
                .GRANTED_WHEN_IN_USE:
                console.log("Permission granted only when in use");
                checkLocationStatus();
                break;
            }
          },
          function (error) {
            console.error(error);
          },
          cordova.plugins.diagnostic.locationAuthorizationMode.ALWAYS
        );
      }

      // check location access status
      function checkLocationAccess() {
        cordova.plugins.diagnostic.getLocationAuthorizationStatus(
          function (status) {
            switch (status) {
              case cordova.plugins.diagnostic.permissionStatus.NOT_REQUESTED:
                console.log("Permission not requested");
                punchContainerInner(
                  `<p>Location Access needed in order to perform this Action.</p>`
                );
                requestLocationPermission();
                break;
              case cordova.plugins.diagnostic.permissionStatus.DENIED_ONCE:
                console.log("Permission denied");
                punchContainerInner(
                  `<p>Location Access needed in order to perform this Action.</p>`
                );
                requestLocationPermission();
                break;
              case cordova.plugins.diagnostic.permissionStatus.DENIED_ALWAYS:
                console.log("Permission permanently denied");
                punchContainerInner(
                  `<p>Location Access needed in order to perform this Action.</p>`
                );
                requestLocationPermission();
                break;
              case cordova.plugins.diagnostic.permissionStatus.GRANTED:
                console.log("Permission granted always");
                checkLocationStatus();
                break;
              case cordova.plugins.diagnostic.permissionStatus
                .GRANTED_WHEN_IN_USE:
                console.log(
                  "Permission granted only when in use (Android >= 10)"
                );
                checkLocationStatus();
                break;
            }
          },
          function (error) {
            console.error(error);
          }
        );
      }

      this.onShow = function () {};
      this.onHide = function () {};
      this.onDestroy = function () {
        console.log("destroy");
        cordova.plugins.diagnostic.registerLocationStateChangeHandler(false);
      };
    };
  </script>
</ons-page>
